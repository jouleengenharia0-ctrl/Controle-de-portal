<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Acessos Joule Eco</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --disponivel: #27ae60; --ocupado: #c0392b; --alerta: #f39c12; --dark: #2c3e50; }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; margin: 0; padding: 20px; color: var(--dark); }
        h1 { text-align: center; color: var(--dark); margin-bottom: 10px; }
        
        /* Container de Login */
        .login-box { 
            background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            margin: 0 auto 30px auto; max-width: 450px; text-align: center; 
        }
        .user-logado-info { font-size: 1.2rem; font-weight: bold; color: #2980b9; }
        .btn-logout { background: none; border: none; color: #e74c3c; cursor: pointer; text-decoration: underline; display: block; width: 100%; margin-top: 10px; }

        /* Grid e Estacionamento de Portais */
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; max-width: 1200px; margin: 0 auto; }
        .card { background: white; border-radius: 15px; padding: 20px; position: relative; box-shadow: 0 4px 8px rgba(0,0,0,0.05); border-top: 10px solid var(--disponivel); transition: 0.3s; }
        .card.busy { border-top-color: var(--ocupado); }

        /* Botão do Sino */
        .btn-sino { position: absolute; top: 15px; right: 15px; cursor: pointer; border: none; background: none; font-size: 1.6rem; color: var(--alerta); display: none; }
        .card.busy .btn-sino { display: block; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

        .portal-nome { font-size: 1.3rem; font-weight: bold; margin: 5px 0; }
        .acesso-email { color: #7f8c8d; font-size: 0.9rem; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .user-at-moment { font-weight: 600; color: #34495e; height: 24px; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 8px; }

        button.action-btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; transition: 0.2s; }
        .btn-entrar { background: var(--disponivel); color: white; }
        .btn-sair { background: var(--dark); color: white; }

        /* Tremer card no alerta */
        .shake-effect { animation: shake 0.5s infinite; }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(5px); } 50% { transform: translateX(-5px); } 75% { transform: translateX(5px); } 100% { transform: translateX(0); } }
    </style>
</head>
<body>

    <h1>Painel de Controle Joule</h1>

    <div class="login-box" id="loginArea">
        </div>

    <div class="grid" id="mainGrid"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // CONFIGURAÇÕES DO SEU FIREBASE
        const firebaseConfig = {
            apiKey: "SUA_API_KEY",
            authDomain: "controle-b334e.firebaseapp.com",
            databaseURL: "https://controle-b334e-default-rtdb.firebaseio.com",
            projectId: "controle-b334e",
            storageBucket: "controle-b334e.appspot.com",
            messagingSenderId: "SEU_SENDER_ID",
            appId: "SEU_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const portaisInfo = [
            { id: 'celpe1', nome: 'CELPE', email: 'joule@joule.eco.br' },
            { id: 'celpe2', nome: 'CELPE', email: 'portal@joule.eco.br' },
            { id: 'cosern1', nome: 'COSERN', email: 'joule@joule.eco.br' },
            { id: 'cosern2', nome: 'COSERN', email: 'portal@joule.eco.br' }
        ];

        // --- LÓGICA DE LOGIN ---
        let usuarioLogado = localStorage.getItem('joule_user') || "";

        function atualizarUI_Login() {
            const area = document.getElementById('loginArea');
            if (!usuarioLogado) {
                area.innerHTML = `
                    <h3>Acesso ao Painel</h3>
                    <select id="selectUser" onchange="logar(this.value)" style="padding:10px; width:80%; border-radius:5px;">
                        <option value="">Escolha seu Perfil...</option>
                        <option value="Gabriel">Gabriel</option><option value="Weslly">Weslly</option>
                        <option value="Vitor">Vitor</option><option value="Matheus">Matheus</option>
                        <option value="Alexandre">Alexandre</option><option value="Iara">Iara</option>
                        <option value="Aparecida">Aparecida</option><option value="Cristiane">Cristiane</option>
                        <option value="Ednalda">Ednalda</option>
                    </select>
                `;
            } else {
                area.innerHTML = `
                    <p>Bem-vindo, <span class="user-logado-info">${usuarioLogado}</span></p>
                    <button class="btn-logout" onclick="deslogar()">Trocar de Usuário</button>
                `;
            }
        }

        window.logar = (nome) => {
            if (nome) { localStorage.setItem('joule_user', nome); location.reload(); }
        };

        window.deslogar = () => {
            localStorage.removeItem('joule_user'); location.reload();
        };

        // --- RENDERIZAR PORTAIS ---
        const grid = document.getElementById('mainGrid');
        portaisInfo.forEach(p => {
            grid.innerHTML += `
                <div id="card-${p.id}" class="card">
                    <button class="btn-sino" onclick="alertarDono('${p.id}')"><i class="fa-solid fa-bell"></i></button>
                    <p class="portal-nome">${p.nome}</p>
                    <p class="acesso-email">${p.email}</p>
                    <div id="user-${p.id}" class="user-at-moment">Livre</div>
                    <button id="btn-${p.id}" class="action-btn btn-entrar" onclick="acaoPortal('${p.id}')">Entrar</button>
                </div>
            `;
        });

        // --- BOTÃO ENTRAR/SAIR ---
        window.acaoPortal = (id) => {
            if (!usuarioLogado) return alert("Faça login primeiro!");
            const btn = document.getElementById(`btn-${id}`);
            const refP = ref(db, 'acessos/' + id);

            if (btn.innerText === "Entrar") {
                set(refP, { status: 'ocupado', user: usuarioLogado });
            } else {
                set(refP, { status: 'livre', user: '' });
            }
        };

        // --- SINO DE ALERTA DIRECIONADO ---
        window.alertarDono = (id) => {
            onValue(ref(db, 'acessos/' + id), (snap) => {
                const data = snap.val();
                if (data && data.status === 'ocupado') {
                    set(ref(db, 'notificacao'), { para: data.user, de: usuarioLogado, time: Date.now() });
                }
            }, { onlyOnce: true });
        };

        // --- SINCRONIZAÇÃO FIREBASE ---
        portaisInfo.forEach(p => {
            onValue(ref(db, 'acessos/' + p.id), (snap) => {
                const d = snap.val() || { status: 'livre', user: '' };
                const card = document.getElementById(`card-${p.id}`);
                const userBox = document.getElementById(`user-${p.id}`);
                const btn = document.getElementById(`btn-${p.id}`);

                if (d.status === 'ocupado') {
                    card.className = "card busy";
                    userBox.innerHTML = `<i class="fa-solid fa-user-lock"></i> ${d.user}`;
                    btn.innerText = "Sair"; btn.className = "action-btn btn-sair";
                } else {
                    card.className = "card";
                    userBox.innerHTML = "Livre";
                    btn.innerText = "Entrar"; btn.className = "action-btn btn-entrar";
                }
            });
        });

        // --- ESCUTAR ALERTAS (SÓ PARA O DONO) ---
        onValue(ref(db, 'notificacao'), (snap) => {
            const alertData = snap.val();
            if (alertData && alertData.para === usuarioLogado) {
                const audio = new AudioContext();
                const osc = audio.createOscillator();
                osc.connect(audio.destination);
                osc.start(); osc.stop(audio.currentTime + 1.5);
                if(navigator.vibrate) navigator.vibrate(800);
                alert(`ATENÇÃO ${usuarioLogado.toUpperCase()}!\nEstão solicitando este portal.`);
            }
        });

        atualizarUI_Login();
    </script>
</body>
</html>
