<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Acessos Joule Eco</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --disponivel: #27ae60;
            --ocupado: #c0392b;
            --alerta: #f39c12;
            --dark: #2c3e50;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, sans-serif; 
            background: #f0f2f5; 
            margin: 0; 
            padding: 20px; 
            color: var(--dark); 
        }

        h1 { text-align: center; margin-bottom: 30px; }

        /* Container de Perfil */
        .perfil-container { 
            background: white; 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            margin-bottom: 30px; 
            text-align: center; 
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        select { 
            padding: 12px; 
            font-size: 16px; 
            border-radius: 8px; 
            width: 100%; 
            max-width: 300px; 
            border: 2px solid #ddd; 
            outline: none;
        }

        /* Grid de Cards */
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 20px; 
            max-width: 1200px; 
            margin: 0 auto; 
        }

        .card { 
            background: white; 
            border-radius: 15px; 
            padding: 25px; 
            position: relative; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); 
            border-top: 8px solid var(--disponivel); 
            transition: transform 0.2s, box-shadow 0.2s; 
        }

        .card.busy { border-top-color: var(--ocupado); }

        /* Sino de Alerta */
        .btn-sino { 
            position: absolute; 
            top: 15px; 
            right: 15px; 
            cursor: pointer; 
            border: none; 
            background: none; 
            font-size: 1.3rem; 
            transition: 0.2s; 
        }

        .card.busy .btn-sino { color: var(--alerta); display: block; }
        .card.free .btn-sino { display: none; }
        .btn-sino:hover { transform: scale(1.2); }

        .portal-nome { font-size: 1.4rem; font-weight: bold; margin: 0; color: #333; }
        .acesso-email { color: #666; font-size: 0.9rem; margin-bottom: 15px; }

        .status-badge { 
            display: inline-block; 
            padding: 6px 15px; 
            border-radius: 20px; 
            font-size: 0.8rem; 
            font-weight: bold; 
            margin-bottom: 15px; 
        }
        .status-badge.free { background: #eafaf1; color: var(--disponivel); }
        .status-badge.busy { background: #fdedec; color: var(--ocupado); }

        .user-info { 
            font-style: italic; 
            font-size: 0.95rem; 
            margin-bottom: 20px; 
            height: 20px; 
            color: var(--dark);
            font-weight: 600;
        }

        /* Botões */
        button.main-btn { 
            width: 100%; 
            padding: 14px; 
            border: none; 
            border-radius: 8px; 
            font-weight: bold; 
            font-size: 1rem;
            cursor: pointer; 
            transition: 0.2s;
        }

        .btn-entrar { background: var(--disponivel); color: white; }
        .btn-entrar:hover { background: #219150; }
        .btn-sair { background: var(--dark); color: white; }
        .btn-sair:hover { background: #1a252f; }

        /* Animação Vibrar */
        @keyframes tremer {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            100% { transform: translate(1px, 1px) rotate(0deg); }
        }
        .animar-alerta { animation: tremer 0.5s; animation-iteration-count: 4; }
    </style>
</head>
<body>

    <h1>Painel de Acessos Joule Eco</h1>

    <div class="perfil-container">
        <label><strong>Selecione seu nome para começar:</strong></label><br><br>
        <select id="selectPerfil">
            <option value="">-- Colaborador --</option>
            <option value="Gabriel">Gabriel</option>
            <option value="Weslly">Weslly</option>
            <option value="Vitor">Vitor</option>
            <option value="Matheus">Matheus</option>
            <option value="Alexandre">Alexandre</option>
            <option value="Iara">Iara</option>
            <option value="Aparecida">Aparecida</option>
            <option value="Cristiane">Cristiane</option>
            <option value="Ednalda">Ednalda</option>
        </select>
    </div>

    <div class="grid" id="portalGrid">
        </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Identificador único para esta aba evitar que o próprio som toque para quem clicou
        const meuIdNavegador = Math.random().toString(36).substring(7);

        // CONFIGURAÇÃO DO SEU FIREBASE
        const firebaseConfig = {
            apiKey: "SUA_API_KEY",
            authDomain: "controle-b334e.firebaseapp.com",
            databaseURL: "https://controle-b334e-default-rtdb.firebaseio.com",
            projectId: "controle-b334e",
            storageBucket: "controle-b334e.appspot.com",
            messagingSenderId: "SEU_ID",
            appId: "SEU_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const listaPortais = [
            { id: 'celpe-joule', nome: 'CELPE', email: 'joule@joule.eco.br' },
            { id: 'celpe-portal', nome: 'CELPE', email: 'portal@joule.eco.br' },
            { id: 'cosern-joule', nome: 'COSERN', email: 'joule@joule.eco.br' },
            { id: 'cosern-portal', nome: 'COSERN', email: 'portal@joule.eco.br' }
        ];

        // 1. Renderizar os cards na tela
        const gridElement = document.getElementById('portalGrid');
        listaPortais.forEach(p => {
            gridElement.innerHTML += `
                <div id="card-${p.id}" class="card free">
                    <button class="btn-sino" title="Alertar esquecimento" onclick="enviarAlerta('${p.id}', '${p.nome}')">
                        <i class="fa-solid fa-bell"></i>
                    </button>
                    <p class="portal-nome">${p.nome}</p>
                    <p class="acesso-email">${p.email}</p>
                    <div id="badge-${p.id}" class="status-badge free">LIVRE</div>
                    <div id="user-${p.id}" class="user-info"></div>
                    <button id="btn-${p.id}" class="main-btn btn-entrar" onclick="gerenciarAcesso('${p.id}')">Entrar</button>
                </div>
            `;
        });

        // 2. Lógica de Entrar/Sair
        window.gerenciarAcesso = (id) => {
            const nomeLogado = document.getElementById('selectPerfil').value;
            const btnAcao = document.getElementById(`btn-${id}`);
            
            if (!nomeLogado && btnAcao.innerText === "Entrar") {
                alert("Por favor, selecione seu nome no topo da página.");
                return;
            }

            const refNoBanco = ref(db, 'portais/' + id);
            
            if (btnAcao.innerText === "Entrar") {
                set(refNoBanco, { ocupado: true, usuario: nomeLogado });
            } else {
                set(refNoBanco, { ocupado: false, usuario: "" });
            }
        };

        // 3. Função de Alerta (Sino)
        window.enviarAlerta = (idCard, nomePortal) => {
            const quemChamou = document.getElementById('selectPerfil').value || "Alguém";
            set(ref(db, 'alerta_vaga'), {
                idOrigem: idCard,
                quemEnviou: meuIdNavegador,
                texto: `${quemChamou} está solicitando o portal ${nomePortal}`,
                timestamp: serverTimestamp()
            });
        };

        // 4. Ouvir mudanças nos Portais
        listaPortais.forEach(p => {
            onValue(ref(db, 'portais/' + p.id), (snapshot) => {
                const info = snapshot.val() || { ocupado: false, usuario: "" };
                const card = document.getElementById(`card-${p.id}`);
                const badge = document.getElementById(`badge-${p.id}`);
                const userArea = document.getElementById(`user-${p.id}`);
                const btn = document.getElementById(`btn-${p.id}`);

                if (info.ocupado) {
                    card.className = "card busy";
                    badge.className = "status-badge busy";
                    badge.innerText = "OCUPADO";
                    userArea.innerText = "Em uso por: " + info.usuario;
                    btn.innerText = "Sair";
                    btn.className = "main-btn btn-sair";
                } else {
                    card.className = "card free";
                    badge.className = "status-badge free";
                    badge.innerText = "LIVRE";
                    userArea.innerText = "";
                    btn.innerText = "Entrar";
                    btn.className = "main-btn btn-entrar";
                }
            });
        });

        // 5. Função de Som (Beep)
        const dispararBeep = () => {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.type = 'sine';
            osc.frequency.value = 880; 
            osc.start();
            gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.8);
            osc.stop(audioCtx.currentTime + 0.8);
        };

        // 6. Ouvir ALERTAS (com filtro para não apitar no próprio)
        onValue(ref(db, 'alerta_vaga'), (snapshot) => {
            const alerta = snapshot.val();
            if (!alerta) return;

            // Se fui eu que cliquei, não faz nada
            if (alerta.quemEnviou === meuIdNavegador) return;

            // Se for outra pessoa:
            dispararBeep();
            if (navigator.vibrate) navigator.vibrate([300, 100, 300]);

            const cardAlvo = document.getElementById(`card-${alerta.idOrigem}`);
            if (cardAlvo) {
                cardAlvo.classList.add('animar-alerta');
                setTimeout(() => cardAlvo.classList.remove('animar-alerta'), 2000);
            }
        });
    </script>
</body>
</html>
